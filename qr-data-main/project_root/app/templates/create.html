{% extends "base.html" %}
{% block title %}Создание кода{% endblock %}
{% block content %}
<div class="header-box">
  <h1>Создать код</h1>
</div>

{% if not user %}
<div id="loginPrompt" class="card" style="background:#1a2332; border:2px solid #3b82f6; margin-bottom:16px;">
  <h3 style="margin-top:0;">Требуется авторизация</h3>
  <p class="hint">Войдите в систему для создания кодов</p>
  <form method="post" action="{{ url_for('auth.login') }}" class="grid" style="margin-top:12px;">
    <input type="hidden" name="next" value="{{ request.path }}">
    <label>Логин
      <input name="username" required>
    </label>
    <label>Пароль
      <input name="password" type="password" required>
    </label>
    <button class="btn primary" type="submit">Войти</button>
  </form>
</div>

<style>
  form[action="{{ url_for('create.make') }}"], .preview { opacity: 0.3; pointer-events: none; }
</style>
{% endif %}

<form method="post" action="{{ url_for('create.make') }}" class="card">
  <label>Текст
    <textarea name="text" rows="4" maxlength="5000">{{ request.args.get('prefill','') }}</textarea>
  </label>

  <div class="row">
    <label>Тип кода
      <select name="code_type">
        <option value="QR">QR Code</option>
        <option value="DM">DataMatrix</option>
        <option value="C128">Code 128</option>
        <option value="PDF417">PDF417</option>
        <option value="AZTEC">Aztec</option>
      </select>
    </label>
    <label>Размер (px)
      <input type="number" name="size" value="{{ size or 300 }}" min="100" max="1200" step="10">
    </label>
  </div>

  <div id="additional-fields" style="display: none;">
    <label id="text-under-label">Текст под кодом
      <input type="text" name="text_under" id="text_under" maxlength="100" placeholder="Дополнительный текст под кодом">
    </label>
  </div>

  <button class="btn">Сформировать</button>
</form>

{% if preview_file %}
<div class="preview card">
  <h3>Превью</h3>
  <img id="previewImg" src="{{ url_for('create.file', name=preview_file) }}" alt="code">
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  const codeTypeSelect = document.querySelector('select[name="code_type"]');
  const additionalFields = document.getElementById('additional-fields');
  const textUnderLabel = document.getElementById('text-under-label');
  const previewImg = document.getElementById('previewImg');
  
  function toggleAdditionalFields() {
    const codeType = codeTypeSelect.value;
    if (codeType === 'C128' || codeType === 'PDF417') {
      additionalFields.style.display = 'block';
    } else {
      additionalFields.style.display = 'none';
    }
  }
  
  function dynamicResize(img){
    if(!img) return;
    if(img.naturalWidth > 600 || img.naturalHeight > 600){
      img.style.maxHeight = Math.max(420, img.naturalHeight) + 'px';
      img.style.minHeight = '210px';
    } else {
      img.style.maxHeight = '210px';
      img.style.minHeight = '210px';
    }
  }
  
  codeTypeSelect.addEventListener('change', toggleAdditionalFields);
  toggleAdditionalFields(); // Initial check
  
  if(previewImg){
    if(previewImg.complete){
      dynamicResize(previewImg);
    } else {
      previewImg.onload = () => dynamicResize(previewImg);
    }
  }
});
</script>
{% endblock %}