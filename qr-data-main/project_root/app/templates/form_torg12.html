{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width:980px;margin:0 auto;">

  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
    <a class="btn" href="{% if request.args.get('from_scan') %}{{ url_for('scan.scan_page') }}{% else %}{{ url_for('forms.create_free') }}{% endif %}">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="header-box" style="flex: 1;">
      <h2>–¢–û–†–ì-12</h2>
    </div>
  </div>

  {% if not result_image %}
  <form method="post" class="grid" style="margin-top:12px;" id="torgForm">
    <div class="two" style="align-items:end;">
      <label>–¢–∏–ø –∫–æ–¥–∞
        <select name="code_type" id="t_type">
          <option value="QR" {% if code_type=='QR' %}selected{% endif %}>QR</option>
          <option value="DM" {% if code_type=='DM' %}selected{% endif %}>DataMatrix</option>
          <option value="C128" {% if code_type=='C128' %}selected{% endif %}>Code 128</option>
          <option value="PDF417" {% if code_type=='PDF417' %}selected{% endif %}>PDF417</option>
          <option value="AZTEC" {% if code_type=='AZTEC' %}selected{% endif %}>Aztec</option>
        </select>
      </label>
      <label>–†–∞–∑–º–µ—Ä –ø–æ –ì–û–°–¢
        <select name="size" id="t_size"></select>
        <input type="hidden" name="gost_code" id="gost_code">
      </label>
    </div>

    <div class="table-wrap" style="overflow:auto;margin-top:8px;">
      <table>
        <thead>
          <tr><th>–ö–æ–¥</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>
        </thead>
        <tbody id="torgBody">
          {% for code, label in fields %}
          <tr>
            <td>{{ code }}</td>
            <td>{{ label }}</td>
            <td><input name="f_{{ code }}" value="{{ (initial[code] if initial else '') | default('') }}"></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="counter" id="cnt">–û—Å—Ç–∞–ª–æ—Å—å: 0 —Å–∏–º–≤–æ–ª–æ–≤</div>

    <div style="display:flex;gap:8px;margin-top:12px;align-items:center;flex-wrap:wrap;">
      <button class="btn primary" type="submit" id="submitBtn">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
      <label style="display:flex;align-items:center;gap:6px;" id="editToggleLabel">
        <input type="checkbox" id="readonlyToggle" style="width:auto;"> 
        <span id="toggleText">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
        <span id="toggleIcon" style="color: #10b981;">‚úì</span>
      </label>
    </div>
  </form>
  {% endif %}

  {% if result_image %}
  <div class="card" style="margin-top:16px;">
    <h3>–ì–æ—Ç–æ–≤–æ</h3>

    <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
      <img src="{{ result_image }}" alt="code" style="max-width:320px;display:block;border-radius:8px;">

      <div style="flex:1;min-width:280px;">
        <label>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞</label>
        <textarea id="encText" readonly rows="6"
          style="width:100%;background:#0b1220;color:#e6e6e6;border:1px solid #374151;border-radius:8px;padding:10px;resize:none;overflow:hidden;white-space:pre-wrap;line-height:1.4;">{{ encoded }}</textarea>

        <div class="two" style="margin-top:10px;align-items:end;">
          <label>–§–æ—Ä–º–∞—Ç
            <select id="fmt">
              <option value="png">PNG</option>
              <option value="jpg">JPG</option>
              <option value="pdf">PDF</option>
            </select>
          </label>
          <div></div>
        </div>

        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px;">
          <button id="saveOne" class="btn primary" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          {% include '_print_size_controls.html' %}
          <a class="btn danger" href="{{ url_for('forms.form_torg12') }}">–£–¥–∞–ª–∏—Ç—å</a>
        </div>

        <div class="hint" id="fsHint" style="margin-top:6px;display:none;">–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—ã–±–æ—Ä –º–µ—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚Äî –±—É–¥–µ—Ç –æ–±—ã—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞.</div>
      </div>
    </div>
  </div>

  <form id="sf" method="post" action="{{ url_for('forms.api_save_code') }}" target="_blank" style="display:none;">
    <input type="hidden" name="text" value="{{ encoded }}">
    <input type="hidden" name="code_type" value="{{ code_type or 'QR' }}">
    <input type="hidden" name="size" value="{{ size or 300 }}">
    <input type="hidden" name="fmt" id="sfmt" value="png">
  </form>
  {% endif %}

</div>

<script>
(function(){
  const GOST_PRESETS={
    QR:[
      {v:177,g:'QR-S1',l:'QR-S1: –ú–∞–ª—ã–π (15√ó15 –º–º)'},
      {v:236,g:'QR-S2',l:'QR-S2: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¢–û–†–ì-12 (20√ó20 –º–º)'},
      {v:295,g:'QR-S3',l:'QR-S3: –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π (25√ó25 –º–º)'},
      {v:354,g:'QR-S4',l:'QR-S4: –ü–µ—á–∞—Ç–Ω—ã–π (30√ó30 –º–º)'}
    ],
    DM:[
      {v:94,g:'DM-S1',l:'DM-S1: –ú–∏–∫—Ä–æ (8√ó8 –º–º)'},
      {v:142,g:'DM-S2',l:'DM-S2: –ú–∞–ª—ã–π (12√ó12 –º–º)'},
      {v:189,g:'DM-S3',l:'DM-S3: –°—Ä–µ–¥–Ω–∏–π (16√ó16 –º–º)'},
      {v:236,g:'DM-S4',l:'DM-S4: –ë–æ–ª—å—à–æ–π (20√ó20 –º–º)'}
    ],
    C128:[
      {v:94,g:'C128-H1',l:'C128-H1: –ù–∏–∑–∫–∏–π (30√ó8 –º–º)'},
      {v:142,g:'C128-H2',l:'C128-H2: –°—Ä–µ–¥–Ω–∏–π (40√ó12 –º–º)'},
      {v:177,g:'C128-H3',l:'C128-H3: –í—ã—Å–æ–∫–∏–π (50√ó15 –º–º)'},
      {v:236,g:'C128-H4',l:'C128-H4: –ü–µ—á–∞—Ç–Ω—ã–π (60√ó20 –º–º)'}
    ],
    PDF417:[
      {v:118,g:'PDF417-S1',l:'PDF417-S1: –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π (25√ó10 –º–º)'},
      {v:177,g:'PDF417-S2',l:'PDF417-S2: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (35√ó15 –º–º)'},
      {v:236,g:'PDF417-S3',l:'PDF417-S3: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π (45√ó20 –º–º)'},
      {v:295,g:'PDF417-S4',l:'PDF417-S4: –ü–æ–ª–Ω—ã–π (55√ó25 –º–º)'}
    ],
    AZTEC:[
      {v:177,g:'AZ-S1',l:'AZ-S1: –ú–∞–ª—ã–π (15√ó15 –º–º)'},
      {v:236,g:'AZ-S2',l:'AZ-S2: –°—Ä–µ–¥–Ω–∏–π (20√ó20 –º–º)'},
      {v:295,g:'AZ-S3',l:'AZ-S3: –ë–æ–ª—å—à–æ–π (25√ó25 –º–º)'},
      {v:354,g:'AZ-S4',l:'AZ-S4: –ü–µ—á–∞—Ç–Ω—ã–π (30√ó30 –º–º)'}
    ]
  };
  function fill(select,type,current){
    select.innerHTML='';
    (GOST_PRESETS[type]||GOST_PRESETS.QR).forEach((p,i)=>{
      const opt=document.createElement('option'); 
      opt.value=p.v; 
      opt.textContent=p.l;
      opt.dataset.gost=p.g;
      if(current ? String(p.v)==String(current) : i===1) opt.selected=true; // Default to S2 (–¢–û–†–ì-12)
      select.appendChild(opt);
    });
  }

  {% if not result_image %}
  const t=document.getElementById('t_type');
  const s=document.getElementById('t_size');
  const gostInput=document.getElementById('gost_code');
  fill(s,t.value,{{ size or 236 }});
  
  t.addEventListener('change',()=>{ 
    fill(s,t.value); 
    updateCounter();
    // Update hidden GOST code
    const selected = s.selectedOptions[0];
    if(gostInput && selected) gostInput.value = selected.dataset.gost || '';
  });
  
  s.addEventListener('change',()=>{
    // Update hidden GOST code when size changes
    const selected = s.selectedOptions[0];
    if(gostInput && selected) gostInput.value = selected.dataset.gost || '';
  });
  
  // Initialize GOST code
  if(gostInput && s.selectedOptions[0]) {
    gostInput.value = s.selectedOptions[0].dataset.gost || '';
  }

  const inputs=[...document.querySelectorAll('#torgBody input')];
  const cnt=document.getElementById('cnt');

  function charLen(str){ return (str||'').length }
  function currentJoined(){ return inputs.map(el=>el.value).join('|'); }

  function updateCounter(){
    const lim = t.value==='DM' ? 3116 : 1850; // –ª–∏–º–∏—Ç –≤ —Å–∏–º–≤–æ–ª–∞—Ö (–ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω–æ)
    const used = charLen(currentJoined());
    const left = Math.max(0, lim - used);
    cnt.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${left} —Å–∏–º–≤–æ–ª–æ–≤`;
    cnt.className = 'counter' + (left===0 ? ' bad' : (left < Math.round(lim*0.15) ? ' warn' : ''));
  }
  inputs.forEach(i=>i.addEventListener('input',updateCounter));
  updateCounter();

  // Handle readonly toggle with better styling and visibility
  const readonlyToggle = document.getElementById('readonlyToggle');
  const toggleText = document.getElementById('toggleText');
  const toggleIcon = document.getElementById('toggleIcon');
  const submitBtn = document.getElementById('submitBtn');
  const typeSelect = document.getElementById('t_type');
  const sizeSelect = document.getElementById('t_size');
  
  readonlyToggle.addEventListener('change', e => {
    const isReadonly = e.target.checked;
    inputs.forEach(i => i.readOnly = isReadonly);
    
    if (isReadonly) {
      toggleText.textContent = '–†–∞–∑—Ä–µ—à–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
      toggleIcon.textContent = 'üîì';
      toggleIcon.style.color = '#3b82f6';
      // Hide code type and size selects when readonly
      typeSelect.style.display = 'none';
      sizeSelect.style.display = 'none';
      typeSelect.parentElement.style.display = 'none';
      sizeSelect.parentElement.style.display = 'none';
    } else {
      toggleText.textContent = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
      toggleIcon.textContent = '‚úì';
      toggleIcon.style.color = '#10b981';
      // Show code type and size selects when editable
      typeSelect.style.display = 'block';
      sizeSelect.style.display = 'block';
      typeSelect.parentElement.style.display = 'block';
      sizeSelect.parentElement.style.display = 'block';
    }
  });
  
  // Check if opened from scan with readonly mode
  if (new URLSearchParams(window.location.search).get('from_scan') === '1') {
    readonlyToggle.checked = true;
    readonlyToggle.dispatchEvent(new Event('change'));
  }
  {% endif %}

  {% if result_image %}
  function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }
  const encEl=document.getElementById('encText'); if(encEl) autoGrow(encEl);

  async function getDataUrl(){
    const text = encEl.value || '';
    const code_type = "{{ code_type or 'QR' }}";
    const size = Number("{{ size or 300 }}");
    const r = await fetch('{{ url_for("forms.api_generate_code") }}',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ text, code_type, size })
    });
    const j = await r.json();
    if(!j || !j.ok) throw new Error('gen failed');
    return j.data_url;
  }

  async function saveSmart(){
    const fmt = document.getElementById('fmt').value;
    if(!('showSaveFilePicker' in window)){
      document.getElementById('fsHint').style.display='block';
      document.getElementById('sfmt').value = fmt;
      document.getElementById('sf').submit();
      return;
    }
    if(fmt==='pdf'){
      document.getElementById('sfmt').value='pdf';
      document.getElementById('sf').submit();
      return;
    }
    const suggested = 'torg12_code.'+fmt;
    const handle = await window.showSaveFilePicker({
      suggestedName: suggested,
      types: [{description:'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', accept:{'image/png':['.png'],'image/jpeg':['.jpg','.jpeg']}}]
    });
    const dataUrl = await getDataUrl();
    const res = await fetch(dataUrl);
    let blob = await res.blob();

    if(fmt==='jpg'){
      const bmp = await createImageBitmap(blob);
      const canvas = document.createElement('canvas'); canvas.width=bmp.width; canvas.height=bmp.height;
      const ctx = canvas.getContext('2d'); ctx.drawImage(bmp,0,0);
      blob = await new Promise(r=>canvas.toBlob(r,'image/jpeg',0.95));
    }

    const stream = await handle.createWritable();
    await stream.write(blob);
    await stream.close();
  }

  document.getElementById('saveOne').addEventListener('click', () => { saveSmart().catch(()=>{ document.getElementById('sf').submit(); }); });

  // Initialize print size controls
  if (window.initPrintSizeControls) {
    window.initPrintSizeControls("{{ code_type or 'QR' }}", {{ size or 300 }}, "{{ encoded }}");
  }
  document.getElementById('print').addEventListener('click', ()=>{
    const img = document.querySelector('img[alt="code"]').src;
    
    // Store current input focus state before opening print window
    const activeElement = document.activeElement;
    const allInputs = document.querySelectorAll('input, textarea');
    
    const w = window.open('','_blank');
    w.document.write(`<html><head><title>–ü–µ—á–∞—Ç—å –∫–æ–¥–∞</title><style>html,body{margin:0;padding:0}</style></head><body><img src="${img}" style="max-width:100%;display:block;margin:0 auto;"><script>window.onload=()=>{window.print();setTimeout(()=>window.close(),300)}<\/script></body></html>`);
    w.document.close();
    
    // Restore input functionality after print window operations
    setTimeout(() => {
      allInputs.forEach(input => {
        if (input.parentNode) {
          // Re-enable input responsiveness
          input.blur();
          input.focus();
          input.blur();
        }
      });
      
      // Restore original focus if it was on an input
      if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
        setTimeout(() => activeElement.focus(), 50);
      }
    }, 400);
  });
  {% endif %}
})();
</script>
{% endblock %}
